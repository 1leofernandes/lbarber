<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar - Barbearia Silva</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
        :root {
            --primary-dark: #121212;
            --secondary-dark: #1a1a1a;
            --accent-gold: #d4af37;
            --light-gold: #e6c567;
            --dark-gold: #b8860b;
            --light-gray: #f5f5f5;
            --medium-gray: #8c8c8c;
            --success: #28a745;
            --error: #dc3545;
            --card-bg: #1e1e1e;
            --overlay-bg: rgba(0, 0, 0, 0.9);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--primary-dark);
            color: var(--light-gray);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background-color: var(--primary-dark);
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .back-btn {
            background: none;
            border: none;
            color: var(--accent-gold);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background-color: rgba(212, 175, 55, 0.1);
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--light-gray);
        }
        
        .header-logo {
            height: 40px;
            filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.87));
            border-radius: 8px;
        }
        
        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            padding: 1.5rem;
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .progress-steps::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(212, 175, 55, 0.2);
            transform: translateY(-50%);
            z-index: 1;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid rgba(212, 175, 55, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--medium-gray);
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .step.active .step-circle {
            background: var(--accent-gold);
            color: var(--primary-dark);
            border-color: var(--accent-gold);
        }
        
        .step.completed .step-circle {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .step-label {
            font-size: 0.9rem;
            color: var(--medium-gray);
            text-align: center;
        }
        
        .step.active .step-label {
            color: var(--light-gray);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 1.5rem;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        
        .selection-card {
            background: linear-gradient(145deg, var(--card-bg), #191919);
            border-radius: 16px;
            padding: 1.8rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(212, 175, 55, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .selection-card:hover {
            border-color: var(--accent-gold);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .selection-card.active {
            border-color: var(--accent-gold);
            background: linear-gradient(145deg, rgba(212, 175, 55, 0.05), #191919);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--light-gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--accent-gold);
        }
        
        .card-subtitle {
            color: var(--medium-gray);
            font-size: 0.95rem;
        }
        
        .selected-option {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            padding: 0.8rem 1rem;
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .selected-text {
            color: var(--light-gray);
            font-weight: 500;
        }
        
        .change-btn {
            background: none;
            border: none;
            color: var(--accent-gold);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.3rem 0.8rem;
            border-radius: 5px;
            transition: background 0.3s ease;
        }
        
        .change-btn:hover {
            background: rgba(212, 175, 55, 0.1);
        }
        
        /* Bottom Sheet */
        .bottom-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            backdrop-filter: blur(5px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .bottom-sheet-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--primary-dark);
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
            transform: translateY(100%);
            transition: transform 0.4s ease;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            z-index: 1001;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .bottom-sheet.active {
            transform: translateY(0);
        }
        
        .bottom-sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        }
        
        .bottom-sheet-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--light-gray);
        }
        
        .bottom-sheet-close {
            background: none;
            border: none;
            color: var(--medium-gray);
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .bottom-sheet-close:hover {
            background: rgba(212, 175, 55, 0.1);
            color: var(--accent-gold);
        }
        
        .bottom-sheet-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        /* Options Grid */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .option-card {
            background: var(--card-bg);
            border: 2px solid rgba(212, 175, 55, 0.1);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option-card:hover {
            border-color: var(--accent-gold);
            transform: translateY(-3px);
        }
        
        .option-card.selected {
            border-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.05);
        }
        
        .option-icon {
            font-size: 2rem;
            color: var(--accent-gold);
            margin-bottom: 0.5rem;
        }
        
        .option-title {
            font-weight: 600;
            color: var(--light-gray);
            margin-bottom: 0.3rem;
        }
        
        .option-desc {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        /* Services List */
        .services-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        
        .service-item {
            background: var(--card-bg);
            border: 2px solid rgba(212, 175, 55, 0.1);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .service-item:hover {
            border-color: var(--accent-gold);
        }
        
        .service-item.selected {
            border-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.05);
        }
        
        .service-info {
            flex: 1;
        }
        
        .service-name {
            font-weight: 600;
            color: var(--light-gray);
            margin-bottom: 0.3rem;
        }
        
        .service-duration {
            font-size: 0.85rem;
            color: var(--accent-gold);
        }
        
        .service-price {
            text-align: right;
        }
        
        .original-price {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--light-gray);
        }
        
        .discounted-price {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--success);
        }
        
        .free-badge {
            background: var(--success);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* Date Carousel */
        .date-carousel {
            display: flex;
            gap: 0.8rem;
            overflow-x: auto;
            padding: 0.5rem 0;
            margin-bottom: 1.5rem;
            scrollbar-width: none;
        }
        
        .date-carousel::-webkit-scrollbar {
            display: none;
        }
        
        .date-card {
            flex: 0 0 auto;
            width: 80px;
            background: var(--card-bg);
            border: 2px solid rgba(212, 175, 55, 0.1);
            border-radius: 12px;
            padding: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .date-card:hover {
            border-color: var(--accent-gold);
        }
        
        .date-card.selected {
            border-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.05);
        }
        
        .date-weekday {
            font-size: 0.8rem;
            color: var(--medium-gray);
            margin-bottom: 0.3rem;
        }
        
        .date-day {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--light-gray);
            margin-bottom: 0.3rem;
        }
        
        .date-month {
            font-size: 0.8rem;
            color: var(--medium-gray);
            text-transform: uppercase;
        }
        
        /* Time Slots */
        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }
        
        .time-slot {
            background: var(--card-bg);
            border: 2px solid rgba(212, 175, 55, 0.1);
            border-radius: 8px;
            padding: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .time-slot:hover {
            border-color: var(--accent-gold);
        }
        
        .time-slot.selected {
            border-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.1);
            color: var(--accent-gold);
            font-weight: 600;
        }
        
        .time-slot.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        /* Summary */
        .summary-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid rgba(212, 175, 55, 0.1);
        }
        
        .summary-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--light-gray);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .summary-title i {
            color: var(--accent-gold);
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .summary-item:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--light-gray);
        }
        
        .summary-label {
            color: var(--medium-gray);
        }
        
        .summary-value {
            color: var(--light-gray);
            text-align: right;
        }
        
        .summary-discount {
            color: var(--success);
        }
        
        /* Buttons */
        .btn {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--accent-gold), var(--dark-gold));
            color: var(--primary-dark);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: transparent;
            border: 2px solid var(--accent-gold);
            color: var(--accent-gold);
            margin-top: 1rem;
        }
        
        .btn-secondary:hover {
            background: rgba(212, 175, 55, 0.1);
        }
        
        /* Footer */
        .footer {
            background-color: var(--primary-dark);
            border-top: 1px solid rgba(212, 175, 55, 0.1);
            padding: 1.5rem;
            text-align: center;
            color: var(--medium-gray);
            font-size: 0.9rem;
            margin-top: auto;
        }
        
        .social-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 1rem;
        }
        
        .social-link {
            color: var(--medium-gray);
            font-size: 1.2rem;
            transition: color 0.3s ease;
        }
        
        .social-link:hover {
            color: var(--accent-gold);
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-gold);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (min-width: 768px) {
            .options-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .time-slots-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .bottom-sheet {
                max-width: 600px;
                left: 50%;
                transform: translateX(-50%) translateY(100%);
                border-radius: 20px;
            }
            
            .bottom-sheet.active {
                transform: translateX(-50%) translateY(0);
            }
        }
        
        @media (max-width: 767px) {
            .time-slots-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .header {
                padding: 1rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .selection-card {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <button class="back-btn" onclick="window.location.href='cliente-home.html'">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="page-title">Agendar Serviço</div>
        <img src="assets/image0 (1).jpeg" alt="Barbearia Silva Logo" class="header-logo">
    </header>
    
    <!-- Progress Steps -->
    <div class="progress-steps">
        <div class="step active" id="step1">
            <div class="step-circle">1</div>
            <div class="step-label">Barbeiro</div>
        </div>
        <div class="step" id="step2">
            <div class="step-circle">2</div>
            <div class="step-label">Serviços</div>
        </div>
        <div class="step" id="step3">
            <div class="step-circle">3</div>
            <div class="step-label">Data & Hora</div>
        </div>
        <div class="step" id="step4">
            <div class="step-circle">4</div>
            <div class="step-label">Confirmar</div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Step 1: Selecionar Barbeiro -->
        <div class="selection-card active" id="barbeiroCard">
            <div class="card-header">
                <div>
                    <h2 class="card-title"><i class="fas fa-user"></i> Barbeiro</h2>
                    <p class="card-subtitle">Escolha um barbeiro ou selecione "Sem preferência"</p>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div id="barbeiroSelected" class="selected-option" style="display: none;">
                <div class="selected-text">Sem preferência</div>
                <button class="change-btn">Alterar</button>
            </div>
        </div>
        
        <!-- Step 2: Selecionar Serviços -->
        <div class="selection-card" id="servicosCard">
            <div class="card-header">
                <div>
                    <h2 class="card-title"><i class="fas fa-cut"></i> Serviços</h2>
                    <p class="card-subtitle">Selecione um ou mais serviços</p>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div id="servicosSelected" class="selected-option" style="display: none;">
                <div class="selected-text">Nenhum serviço selecionado</div>
                <button class="change-btn">Alterar</button>
            </div>
        </div>
        
        <!-- Step 3: Selecionar Data e Hora -->
        <div class="selection-card" id="dataHoraCard">
            <div class="card-header">
                <div>
                    <h2 class="card-title"><i class="fas fa-calendar-alt"></i> Data & Hora</h2>
                    <p class="card-subtitle">Escolha quando deseja ser atendido</p>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div id="dataHoraSelected" class="selected-option" style="display: none;">
                <div class="selected-text">Nenhuma data e hora selecionadas</div>
                <button class="change-btn">Alterar</button>
            </div>
        </div>
        
        <!-- Summary Section -->
        <div class="summary-section">
            <h3 class="summary-title"><i class="fas fa-receipt"></i> Resumo</h3>
            
            <div class="summary-item">
                <span class="summary-label">Barbeiro:</span>
                <span class="summary-value" id="summaryBarbeiro">Não selecionado</span>
            </div>
            
            <div class="summary-item">
                <span class="summary-label">Serviços:</span>
                <span class="summary-value" id="summaryServicos">Nenhum</span>
            </div>
            
            <div class="summary-item">
                <span class="summary-label">Data:</span>
                <span class="summary-value" id="summaryData">--/--/----</span>
            </div>
            
            <div class="summary-item">
                <span class="summary-label">Hora:</span>
                <span class="summary-value" id="summaryHora">--:--</span>
            </div>
            
            <div class="summary-item">
                <span class="summary-label">Subtotal:</span>
                <span class="summary-value" id="summarySubtotal">R$ 0,00</span>
            </div>
            
            <div class="summary-item" id="discountItem" style="display: none;">
                <span class="summary-label">Desconto Assinatura:</span>
                <span class="summary-value summary-discount" id="summaryDiscount">-R$ 0,00</span>
            </div>
            
            <div class="summary-item">
                <span class="summary-label">Total:</span>
                <span class="summary-value" id="summaryTotal">R$ 0,00</span>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <button class="btn btn-primary" id="confirmBtn" disabled>
            <i class="fas fa-calendar-check"></i> Confirmar Agendamento
        </button>
        
        <button class="btn btn-secondary" onclick="window.location.href='cliente-home.html'">
            <i class="fas fa-times"></i> Cancelar
        </button>
    </main>
    
    <!-- Bottom Sheet - Barbeiros -->
    <div class="bottom-sheet-overlay" id="barbeiroOverlay"></div>
    <div class="bottom-sheet" id="barbeiroSheet">
        <div class="bottom-sheet-header">
            <h2 class="bottom-sheet-title">Selecione um Barbeiro</h2>
            <button class="bottom-sheet-close" id="closeBarbeiroSheet">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="bottom-sheet-content" id="barbeiroContent">
            <!-- Barbeiros serão carregados aqui -->
            <div class="loading" style="margin: 2rem auto;"></div>
        </div>
        <button class="btn btn-primary" id="confirmBarbeiroBtn" disabled>
            Continuar
        </button>
    </div>
    
    <!-- Bottom Sheet - Serviços -->
    <div class="bottom-sheet-overlay" id="servicosOverlay"></div>
    <div class="bottom-sheet" id="servicosSheet">
        <div class="bottom-sheet-header">
            <h2 class="bottom-sheet-title">Selecione os Serviços</h2>
            <button class="bottom-sheet-close" id="closeServicosSheet">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="bottom-sheet-content" id="servicosContent">
            <!-- Serviços serão carregados aqui -->
            <div class="loading" style="margin: 2rem auto;"></div>
        </div>
        <button class="btn btn-primary" id="confirmServicosBtn" disabled>
            Continuar (<span id="selectedCount">0</span> selecionados)
        </button>
    </div>
    
    <!-- Bottom Sheet - Data e Hora -->
    <div class="bottom-sheet-overlay" id="dataHoraOverlay"></div>
    <div class="bottom-sheet" id="dataHoraSheet">
        <div class="bottom-sheet-header">
            <h2 class="bottom-sheet-title">Selecione Data e Hora</h2>
            <button class="bottom-sheet-close" id="closeDataHoraSheet">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="bottom-sheet-content">
            <!-- Date Carousel -->
            <div class="date-carousel" id="dateCarousel">
                <!-- Datas serão geradas dinamicamente -->
            </div>
            
            <!-- Time Slots -->
            <h3 style="color: var(--light-gray); margin-bottom: 1rem; font-size: 1.1rem;">
                Horários disponíveis para <span id="selectedDateText">hoje</span>:
            </h3>
            <div class="time-slots-grid" id="timeSlotsGrid">
                <!-- Horários serão gerados dinamicamente -->
            </div>
            
            <div id="noSlotsMessage" style="text-align: center; padding: 2rem; color: var(--medium-gray); display: none;">
                <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>Não há horários disponíveis para esta data.</p>
                <p style="font-size: 0.9rem;">Selecione outra data ou tente outro barbeiro.</p>
            </div>
        </div>
        <button class="btn btn-primary" id="confirmDataHoraBtn" disabled>
            Confirmar Data e Hora
        </button>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2023 Barbearia Silva - Sistema de Agendamento. Todos os direitos reservados.</p>
        <div class="social-links">
            <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
            <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
            <a href="#" class="social-link"><i class="fab fa-whatsapp"></i></a>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        // Configurações
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : 'https://barbeariasilva.onrender.com';
        
        const HORARIO_FUNCIONAMENTO = {
            seg_a_sex: { inicio: '08:30', fim: '19:00' },
            sabado: { inicio: '08:30', fim: '18:30' },
            domingo: { inicio: null, fim: null }
        };
        
        // Estado da aplicação
        let estado = {
            token: localStorage.getItem('token'),
            usuario: null,
            assinatura: null,
            barbeiros: [],
            servicos: [],
            selecionados: {
                barbeiro: null, // null = sem preferência
                servicos: [], // Array de IDs de serviços
                data: null,
                horaInicio: null,
                horaFim: null
            },
            horariosDisponiveis: [],
            dataSelecionada: null
        };
        
        // Elementos DOM
        const elementos = {
            // Steps
            step1: document.getElementById('step1'),
            step2: document.getElementById('step2'),
            step3: document.getElementById('step3'),
            step4: document.getElementById('step4'),
            
            // Cards
            barbeiroCard: document.getElementById('barbeiroCard'),
            servicosCard: document.getElementById('servicosCard'),
            dataHoraCard: document.getElementById('dataHoraCard'),
            
            // Selected options
            barbeiroSelected: document.getElementById('barbeiroSelected'),
            servicosSelected: document.getElementById('servicosSelected'),
            dataHoraSelected: document.getElementById('dataHoraSelected'),
            
            // Summary
            summaryBarbeiro: document.getElementById('summaryBarbeiro'),
            summaryServicos: document.getElementById('summaryServicos'),
            summaryData: document.getElementById('summaryData'),
            summaryHora: document.getElementById('summaryHora'),
            summarySubtotal: document.getElementById('summarySubtotal'),
            summaryDiscount: document.getElementById('summaryDiscount'),
            summaryTotal: document.getElementById('summaryTotal'),
            discountItem: document.getElementById('discountItem'),
            
            // Bottom Sheets
            barbeiroSheet: document.getElementById('barbeiroSheet'),
            servicosSheet: document.getElementById('servicosSheet'),
            dataHoraSheet: document.getElementById('dataHoraSheet'),
            
            // Overlays
            barbeiroOverlay: document.getElementById('barbeiroOverlay'),
            servicosOverlay: document.getElementById('servicosOverlay'),
            dataHoraOverlay: document.getElementById('dataHoraOverlay'),
            
            // Content areas
            barbeiroContent: document.getElementById('barbeiroContent'),
            servicosContent: document.getElementById('servicosContent'),
            dateCarousel: document.getElementById('dateCarousel'),
            timeSlotsGrid: document.getElementById('timeSlotsGrid'),
            selectedDateText: document.getElementById('selectedDateText'),
            noSlotsMessage: document.getElementById('noSlotsMessage'),
            
            // Buttons
            confirmBtn: document.getElementById('confirmBtn'),
            confirmBarbeiroBtn: document.getElementById('confirmBarbeiroBtn'),
            confirmServicosBtn: document.getElementById('confirmServicosBtn'),
            confirmDataHoraBtn: document.getElementById('confirmDataHoraBtn'),
            selectedCount: document.getElementById('selectedCount')
        };
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar autenticação
            if (!estado.token) {
                window.location.href = 'login.html';
                return;
            }
            
            // Carregar dados do usuário
            await carregarDadosUsuario();
            
            // Configurar event listeners
            configurarEventListeners();
            
            // Carregar dados iniciais
            await carregarDadosIniciais();
            
            // Atualizar UI
            atualizarUI();
        });
        
        async function carregarDadosUsuario() {
            try {
                const response = await fetch(`${API_BASE_URL}/usuarios/me`, {
                    headers: { 'Authorization': `Bearer ${estado.token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    estado.usuario = data;

                    // Proteção: se o campo assinatura_id existir e for truthy, carregar assinatura
                    if (estado.usuario && estado.usuario.assinatura_id) {
                        await carregarAssinatura(estado.usuario.assinatura_id);
                    }
                    return;
                }

                // Se não ok, logue o erro para debug
                const errBody = await response.text();
                console.error('Erro ao buscar usuário. Status:', response.status, errBody);
            } catch (error) {
                console.error('Erro ao carregar dados do usuário:', error);
            }
        }

        
        async function carregarAssinatura(assinaturaId) {
            try {
                const response = await fetch(`${API_BASE_URL}/assinatura/${assinaturaId}`, {
                    headers: { 'Authorization': `Bearer ${estado.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    estado.assinatura = data.assinatura;
                }
            } catch (error) {
                console.error('Erro ao carregar assinatura:', error);
            }
        }
        
        async function carregarDadosIniciais() {
            await Promise.all([
                carregarBarbeiros(),
                carregarServicos()
            ]);
        }
        
        async function carregarBarbeiros() {
            try {
                const response = await fetch(`${API_BASE_URL}/barbeiros`, {
                    headers: { 'Authorization': `Bearer ${estado.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    estado.barbeiros = data;
                    renderizarBarbeiros();
                }
            } catch (error) {
                console.error('Erro ao carregar barbeiros:', error);
            }
        }
        
        async function carregarServicos() {
            try {
                const response = await fetch(`${API_BASE_URL}/servicos`, {
                    headers: { 'Authorization': `Bearer ${estado.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    estado.servicos = data;
                    renderizarServicos();
                }
            } catch (error) {
                console.error('Erro ao carregar serviços:', error);
            }
        }
        
        function renderizarBarbeiros() {
            elementos.barbeiroContent.innerHTML = '';
            
            // Opção "Sem preferência"
            const semPreferenciaCard = document.createElement('div');
            semPreferenciaCard.className = `option-card ${estado.selecionados.barbeiro === null ? 'selected' : ''}`;
            semPreferenciaCard.innerHTML = `
                <div class="option-icon"><i class="fas fa-users"></i></div>
                <div class="option-title">Sem preferência</div>
                <div class="option-desc">Qualquer barbeiro disponível</div>
            `;
            semPreferenciaCard.onclick = () => selecionarBarbeiro(null);
            elementos.barbeiroContent.appendChild(semPreferenciaCard);
            
            // Barbeiros
            estado.barbeiros.forEach(barbeiro => {
                const card = document.createElement('div');
                card.className = `option-card ${estado.selecionados.barbeiro === barbeiro.id ? 'selected' : ''}`;
                card.innerHTML = `
                    <div class="option-icon"><i class="fas fa-user"></i></div>
                    <div class="option-title">${barbeiro.nome}</div>
                    <div class="option-desc">${barbeiro.especialidade || 'Barbeiro'}</div>
                `;
                card.onclick = () => selecionarBarbeiro(barbeiro.id);
                elementos.barbeiroContent.appendChild(card);
            });
            
            elementos.confirmBarbeiroBtn.disabled = estado.selecionados.barbeiro === undefined;
        }
        
        function renderizarServicos() {
            elementos.servicosContent.innerHTML = '';

            // Percorre os serviços do estado; calcula valor por item dentro do loop
            estado.servicos.forEach(servico => {
                // segurança: garante que valor_servico existe e é número
                const valorNumerico = parseFloat(servico.valor_servico) || 0;

                const item = document.createElement('div');
                item.className = `service-item ${estado.selecionados.servicos.includes(servico.id) ? 'selected' : ''}`;

                // Verificar se o serviço está coberto pela assinatura
                const estaCoberto = estado.assinatura && servico.assinatura_ids &&
                                    Array.isArray(servico.assinatura_ids) &&
                                    servico.assinatura_ids.includes(estado.assinatura.id);

                const precoHtml = estaCoberto
                    ? '<div class="free-badge">INCLUSO</div>'
                    : `<div class="original-price">R$ ${valorNumerico.toFixed(2)}</div>`;

                item.innerHTML = `
                    <div class="service-info">
                        <div class="service-name">${servico.nome_servico}</div>
                        <div class="service-duration">${servico.duracao_servico} min</div>
                    </div>
                    <div class="service-price">
                        ${precoHtml}
                    </div>
                `;

                item.onclick = () => toggleServico(servico.id);
                elementos.servicosContent.appendChild(item);
            });

            atualizarContadorServicos();
        }
        
        function calcularPrecoServico(servico) {
            if (!estado.assinatura || !servico.assinatura_ids) {
                return servico.valor_servico;
            }
            
            // Verificar se a assinatura cobre este serviço
            if (servico.assinatura_ids.includes(estado.assinatura.id)) {
                return 0; // Serviço incluso na assinatura
            }
            
            return servico.valor_servico;
        }
        
        function toggleServico(servicoId) {
            const index = estado.selecionados.servicos.indexOf(servicoId);
            
            if (index === -1) {
                estado.selecionados.servicos.push(servicoId);
            } else {
                estado.selecionados.servicos.splice(index, 1);
            }
            
            renderizarServicos();
            elementos.confirmServicosBtn.disabled = estado.selecionados.servicos.length === 0;
        }
        
        function atualizarContadorServicos() {
            elementos.selectedCount.textContent = estado.selecionados.servicos.length;
        }
        
        function selecionarBarbeiro(barbeiroId) {
            estado.selecionados.barbeiro = barbeiroId;
            renderizarBarbeiros();
            elementos.confirmBarbeiroBtn.disabled = false;
        }
        
        function configurarEventListeners() {
            // Abrir bottom sheets
            elementos.barbeiroCard.onclick = () => abrirBottomSheet('barbeiro');
            elementos.servicosCard.onclick = () => {
                if (estado.selecionados.barbeiro !== undefined) {
                    abrirBottomSheet('servicos');
                } else {
                    alert('Por favor, selecione um barbeiro primeiro.');
                }
            };
            elementos.dataHoraCard.onclick = () => {
                if (estado.selecionados.servicos.length > 0) {
                    abrirBottomSheet('dataHora');
                    gerarDatasCarrossel();
                } else {
                    alert('Por favor, selecione pelo menos um serviço.');
                }
            };
            
            // Fechar bottom sheets
            elementos.barbeiroOverlay.onclick = () => fecharBottomSheet('barbeiro');
            elementos.servicosOverlay.onclick = () => fecharBottomSheet('servicos');
            elementos.dataHoraOverlay.onclick = () => fecharBottomSheet('dataHora');
            
            document.getElementById('closeBarbeiroSheet').onclick = () => fecharBottomSheet('barbeiro');
            document.getElementById('closeServicosSheet').onclick = () => fecharBottomSheet('servicos');
            document.getElementById('closeDataHoraSheet').onclick = () => fecharBottomSheet('dataHora');
            
            // Botões de confirmar nos bottom sheets
            elementos.confirmBarbeiroBtn.onclick = () => {
                confirmarBarbeiro();
                fecharBottomSheet('barbeiro');
            };
            
            elementos.confirmServicosBtn.onclick = () => {
                confirmarServicos();
                fecharBottomSheet('servicos');
            };
            
            elementos.confirmDataHoraBtn.onclick = () => {
                confirmarDataHora();
                fecharBottomSheet('dataHora');
            };
            
            // Botão de confirmar agendamento final
            elementos.confirmBtn.onclick = confirmarAgendamento;
            
            // Botões "Alterar" nos cards
            elementos.barbeiroSelected.querySelector('.change-btn').onclick = () => abrirBottomSheet('barbeiro');
            elementos.servicosSelected.querySelector('.change-btn').onclick = () => abrirBottomSheet('servicos');
            elementos.dataHoraSelected.querySelector('.change-btn').onclick = () => abrirBottomSheet('dataHora');
        }
        
        function abrirBottomSheet(tipo) {
            const sheet = elementos[`${tipo}Sheet`];
            const overlay = elementos[`${tipo}Overlay`];
            
            sheet.classList.add('active');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Se for dataHora, carregar horários para a data selecionada
            if (tipo === 'dataHora' && estado.dataSelecionada) {
                carregarHorariosDisponiveis(estado.dataSelecionada);
            }
        }
        
        function fecharBottomSheet(tipo) {
            const sheet = elementos[`${tipo}Sheet`];
            const overlay = elementos[`${tipo}Overlay`];
            
            sheet.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        function confirmarBarbeiro() {
            // Atualizar UI do card
            const barbeiroNome = estado.selecionados.barbeiro === null 
                ? 'Sem preferência' 
                : estado.barbeiros.find(b => b.id === estado.selecionados.barbeiro)?.nome || 'Barbeiro';
            
            elementos.barbeiroSelected.querySelector('.selected-text').textContent = barbeiroNome;
            elementos.barbeiroSelected.style.display = 'flex';
            
            // Atualizar summary
            elementos.summaryBarbeiro.textContent = barbeiroNome;
            
            // Ativar próximo step
            elementos.servicosCard.classList.add('active');
            elementos.step2.classList.add('active');
            
            atualizarUI();
        }
        
        function confirmarServicos() {
            // Obter nomes dos serviços selecionados
            const servicosSelecionados = estado.servicos
                .filter(s => estado.selecionados.servicos.includes(s.id))
                .map(s => s.nome_servico);
            
            elementos.servicosSelected.querySelector('.selected-text').textContent = 
                servicosSelecionados.join(', ') || 'Nenhum serviço selecionado';
            elementos.servicosSelected.style.display = 'flex';
            
            // Atualizar summary
            elementos.summaryServicos.textContent = servicosSelecionados.join(', ') || 'Nenhum';
            
            // Ativar próximo step
            elementos.dataHoraCard.classList.add('active');
            elementos.step3.classList.add('active');
            
            atualizarUI();
        }
        
        function confirmarDataHora() {
            if (!estado.selecionados.data || !estado.selecionados.horaInicio) {
                alert('Por favor, selecione uma data e horário.');
                return;
            }
            
            // VALIDAÇÃO: Verificar se não está agendando no passado
            const agora = new Date();
            const dataAgendamento = new Date(estado.selecionados.data);
            const [horaAgendamento, minutoAgendamento] = estado.selecionados.horaInicio.split(':').map(Number);
            
            // Criar objeto Date para o horário do agendamento
            const horarioAgendamento = new Date(dataAgendamento);
            horarioAgendamento.setHours(horaAgendamento, minutoAgendamento, 0, 0);
            
            // Se o agendamento for no passado
            if (horarioAgendamento < agora) {
                toast('Não é possível agendar para um horário no passado. Por favor, escolha um horário futuro.', 'error');
                return;
            }
            
            // Formatar data e hora para exibição
            const dataObj = new Date(estado.selecionados.data);
            const dataFormatada = dataObj.toLocaleDateString('pt-BR');
            const horaFormatada = `${estado.selecionados.horaInicio} - ${estado.selecionados.horaFim}`;
            
            elementos.dataHoraSelected.querySelector('.selected-text').textContent = 
                `${dataFormatada} às ${estado.selecionados.horaInicio}`;
            elementos.dataHoraSelected.style.display = 'flex';
            
            // Atualizar summary
            elementos.summaryData.textContent = dataFormatada;
            elementos.summaryHora.textContent = horaFormatada;
            
            // Ativar último step
            elementos.step4.classList.add('active');
            
            atualizarUI();
        }
        
        function gerarDatasCarrossel() {
            elementos.dateCarousel.innerHTML = '';
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0); // Zerar horas para comparar apenas a data
            
            // Gerar próximos 7 dias (começando de HOJE)
            for (let i = 0; i < 7; i++) {
                const data = new Date(hoje);
                data.setDate(hoje.getDate() + i);
                
                // Pular datas passadas (nunca deve acontecer com i >= 0, mas por segurança)
                if (data < hoje && i === 0) {
                    continue; // Garante que não mostre datas passadas
                }
                
                const diaSemana = data.toLocaleDateString('pt-BR', { weekday: 'short' });
                const dia = data.getDate();
                const mes = data.toLocaleDateString('pt-BR', { month: 'short' });
                const dataISO = data.toISOString().split('T')[0];
                
                const dateCard = document.createElement('div');
                dateCard.className = `date-card ${estado.dataSelecionada === dataISO ? 'selected' : ''}`;
                dateCard.innerHTML = `
                    <div class="date-weekday">${diaSemana}</div>
                    <div class="date-day">${dia}</div>
                    <div class="date-month">${mes}</div>
                `;
                
                dateCard.onclick = () => selecionarData(dataISO, dateCard);
                elementos.dateCarousel.appendChild(dateCard);
            }
            
            // Selecionar primeira data por padrão (HOJE)
            if (!estado.dataSelecionada) {
                const primeiraData = new Date(hoje);
                const dataISO = primeiraData.toISOString().split('T')[0];
                
                const primeiroCard = elementos.dateCarousel.querySelector('.date-card');
                if (primeiroCard) {
                    selecionarData(dataISO, primeiroCard);
                }
            }
        }
        
        async function selecionarData(dataISO, cardElement) {
            // Remover seleção anterior
            elementos.dateCarousel.querySelectorAll('.date-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Adicionar seleção atual
            cardElement.classList.add('selected');
            estado.dataSelecionada = dataISO;
            estado.selecionados.data = dataISO;
            
            // Atualizar texto da data selecionada
            const dataObj = new Date(dataISO);
            elementos.selectedDateText.textContent = dataObj.toLocaleDateString('pt-BR', {
                weekday: 'long',
                day: 'numeric',
                month: 'long'
            });
            
            // Carregar horários disponíveis para esta data
            await carregarHorariosDisponiveis(dataISO);
            
            // Habilitar botão de confirmar se já tiver horário selecionado
            elementos.confirmDataHoraBtn.disabled = !estado.selecionados.horaInicio;
        }
        
        async function carregarHorariosDisponiveis(dataISO) {
            try {
                elementos.timeSlotsGrid.innerHTML = '<div class="loading" style="margin: 2rem auto;"></div>';
                elementos.noSlotsMessage.style.display = 'none';
                
                // Calcular duração total dos serviços selecionados
                const duracaoTotal = estado.servicos
                    .filter(s => estado.selecionados.servicos.includes(s.id))
                    .reduce((total, servico) => total + servico.duracao_servico, 0);
                
                // Construir URL da API
                let url = `${API_BASE_URL}/agendamentos/horarios-disponiveis?data=${dataISO}&duracao=${duracaoTotal}`;
                
                if (estado.selecionados.barbeiro !== null) {
                    url += `&barbeiro_id=${estado.selecionados.barbeiro}`;
                }
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${estado.token}` }
                });
                
                if (response.ok) {
                    let horarios = await response.json();
                    
                    // FILTRAR HORÁRIOS PASSADOS se for HOJE
                    const agora = new Date();
                    const dataSelecionada = new Date(dataISO);
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0);
                    dataSelecionada.setHours(0, 0, 0, 0);
                    
                    // Se for hoje, remover horários que já passaram
                    if (dataSelecionada.getTime() === hoje.getTime()) {
                        const horaAtual = agora.getHours();
                        const minutoAtual = agora.getMinutes();
                        
                        horarios = horarios.filter(horario => {
                            const [hora, minuto] = horario.inicio.split(':').map(Number);
                            
                            // Verificar se o horário ainda não passou
                            if (hora < horaAtual) return false;
                            if (hora === horaAtual && minuto <= minutoAtual) return false;
                            
                            return true;
                        });
                    }
                    
                    estado.horariosDisponiveis = horarios;
                    renderizarHorarios(horarios, duracaoTotal);
                }
            } catch (error) {
                console.error('Erro ao carregar horários:', error);
                elementos.timeSlotsGrid.innerHTML = '';
                elementos.noSlotsMessage.style.display = 'block';
            }
        }
        
        function renderizarHorarios(horarios, duracaoTotal) {
            elementos.timeSlotsGrid.innerHTML = '';
            
            if (!horarios || horarios.length === 0) {
                elementos.noSlotsMessage.style.display = 'block';
                return;
            }
            
            elementos.noSlotsMessage.style.display = 'none';
            
            horarios.forEach(horario => {
                const timeSlot = document.createElement('div');
                timeSlot.className = `time-slot ${
                    estado.selecionados.horaInicio === horario.inicio ? 'selected' : ''
                }`;
                timeSlot.textContent = horario.inicio;
                
                timeSlot.onclick = () => selecionarHorario(horario, timeSlot, duracaoTotal);
                elementos.timeSlotsGrid.appendChild(timeSlot);
            });
        }
        
        function selecionarHorario(horario, slotElement, duracaoTotal) {
            const agora = new Date();
            const dataSelecionada = new Date(estado.dataSelecionada);
            const [hora, minutos] = horario.inicio.split(':').map(Number);
            
            // VALIDAÇÃO: Verificar se não está agendando no passado
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            dataSelecionada.setHours(0, 0, 0, 0);
            
            if (dataSelecionada.getTime() === hoje.getTime()) {
                const horaAtual = agora.getHours();
                const minutoAtual = agora.getMinutes();
                
                if (hora < horaAtual || (hora === horaAtual && minutos < minutoAtual)) {
                    toast('Este horário já passou. Por favor, escolha um horário futuro.', 'warning');
                    return;
                }
            }
            
            // Remover seleção anterior
            elementos.timeSlotsGrid.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // Adicionar seleção atual
            slotElement.classList.add('selected');
            
            // Calcular hora de término
            const dataInicio = new Date();
            dataInicio.setHours(hora, minutos, 0, 0);
            
            const dataFim = new Date(dataInicio.getTime() + duracaoTotal * 60000);
            const horaFim = `${String(dataFim.getHours()).padStart(2, '0')}:${String(dataFim.getMinutes()).padStart(2, '0')}`;
            
            // Salvar no estado
            estado.selecionados.horaInicio = horario.inicio;
            estado.selecionados.horaFim = horaFim;
            
            // Habilitar botão de confirmar
            elementos.confirmDataHoraBtn.disabled = false;
        }
        
        function atualizarUI() {
            // Atualizar resumo financeiro
            atualizarResumoFinanceiro();
            
            // Verificar se pode habilitar botão de confirmar
            const podeConfirmar = estado.selecionados.barbeiro !== undefined &&
                                estado.selecionados.servicos.length > 0 &&
                                estado.selecionados.data &&
                                estado.selecionados.horaInicio;
            
            elementos.confirmBtn.disabled = !podeConfirmar;
        }
        
        function atualizarResumoFinanceiro() {
            // Calcular subtotal
            let subtotal = 0;
            let descontoTotal = 0;
            
            estado.selecionados.servicos.forEach(servicoId => {
                const servico = estado.servicos.find(s => s.id === servicoId);
                if (servico) {
                    const precoServico = servico.valor_servico;
                    const precoFinal = calcularPrecoServico(servico);
                    
                    subtotal += precoServico;
                    descontoTotal += (precoServico - precoFinal);
                }
            });
            
            // Atualizar elementos
            elementos.summarySubtotal.textContent = `R$ ${subtotal.toFixed(2)}`;
            elementos.summaryTotal.textContent = `R$ ${(subtotal - descontoTotal).toFixed(2)}`;
            
            // Mostrar/ocultar desconto
            if (descontoTotal > 0) {
                elementos.summaryDiscount.textContent = `-R$ ${descontoTotal.toFixed(2)}`;
                elementos.discountItem.style.display = 'flex';
            } else {
                elementos.discountItem.style.display = 'none';
            }
        }
        
        async function confirmarAgendamento() {
            // Validações básicas
            if (!estado.selecionados.data || !estado.selecionados.horaInicio || !estado.selecionados.horaFim) {
                toast('Selecione uma data e horário válidos.', 'warning');
                return;
            }

            if (estado.selecionados.servicos.length === 0) {
                toast('Selecione pelo menos um serviço.', 'warning');
                return;
            }

            // VALIDAÇÃO FINAL: Verificar se não está agendando no passado
            const agora = new Date();
            const dataAgendamento = new Date(estado.selecionados.data);
            const [horaAgendamento, minutoAgendamento] = estado.selecionados.horaInicio.split(':').map(Number);
            
            // Criar objeto Date para o horário do agendamento
            const horarioAgendamento = new Date(dataAgendamento);
            horarioAgendamento.setHours(horaAgendamento, minutoAgendamento, 0, 0);
            
            // Se o agendamento for no passado
            if (horarioAgendamento < agora) {
                toast('Não é possível agendar para um horário no passado. Por favor, escolha um horário futuro.', 'error');
                return;
            }

            // Toast de carregamento
            const loadingToast = Toastify({
                text: 'Confirmando agendamento...',
                duration: -1,
                gravity: 'top',
                position: 'right',
                style: {
                    background: 'linear-gradient(135deg, #0f172a, #1e293b)',
                    borderRadius: '10px'
                }
            });
            loadingToast.showToast();

            try {
                // Enviar TODOS os serviços em uma única requisição
                const response = await fetch(`${API_BASE_URL}/agendamentos`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${estado.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        barbeiro_id: estado.selecionados.barbeiro,
                        servicos_ids: estado.selecionados.servicos, // ARRAY de IDs
                        data_agendada: estado.selecionados.data,
                        hora_inicio: estado.selecionados.horaInicio,
                        hora_fim: estado.selecionados.horaFim
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Erro ao criar agendamento');
                }

                loadingToast.hideToast();
                toast('Agendamento realizado com sucesso!', 'success');

                // Redirecionamento suave
                setTimeout(() => {
                    window.location.href = 'cliente-home.html';
                }, 1800);

            } catch (error) {
                loadingToast.hideToast();
                console.error(error);
                toast(error.message || 'Erro ao realizar agendamento.', 'error');
            }
        }

        
        // Helper functions
        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            return JSON.parse(atob(base64));
        }
        
        function showNotification(message, type = 'success') {
            // Implemente notificações Toastify se quiser
            alert(message);
        }

        function toast(message, type = 'success') {
            const colors = {
                success: 'linear-gradient(135deg, #16a34a, #22c55e)',
                error: 'linear-gradient(135deg, #dc2626, #ef4444)',
                warning: 'linear-gradient(135deg, #f59e0b, #fbbf24)',
                info: 'linear-gradient(135deg, #0f172a, #1e293b)'
            };

            Toastify({
                text: message,
                duration: 3500,
                close: true,
                gravity: 'top',
                position: 'right',
                stopOnFocus: true,
                style: {
                    background: colors[type] || colors.info,
                    borderRadius: '10px',
                    fontWeight: '500',
                    boxShadow: '0 10px 25px rgba(0,0,0,0.2)'
                }
            }).showToast();
        }

    </script>
</body>
</html>